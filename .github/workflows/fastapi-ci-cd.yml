name: ATS Backend Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Deploy backend to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_MAILBOX: ${{ secrets.AZURE_MAILBOX }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          echo "ðŸ“¦ Compressing backend files for transfer..."
          tar -czf backend.tar.gz ./*

          echo "ðŸ“¤ Copying files to EC2..."
          scp -i private_key.pem -o StrictHostKeyChecking=no backend.tar.gz ${USER}@${HOST}:/tmp/

          echo "ðŸš€ Connecting to EC2 and deploying..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} << 'EOF'
            set -e
            APP_DIR="/var/www/ats/backend"
            BACKUP_DIR="/var/www/ats-backups/backend"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "ðŸ§± Creating backup directory..."
            sudo mkdir -p ${BACKUP_DIR}

            echo "ðŸ“‚ Creating code backup..."
            if [ -d "${APP_DIR}" ]; then
              sudo tar -czf ${BACKUP_DIR}/backend_backup_${TIMESTAMP}.tar.gz -C /var/www/ats backend
              echo "âœ… Backup created at ${BACKUP_DIR}/backend_backup_${TIMESTAMP}.tar.gz"
            else
              echo "âš ï¸ No existing backend folder, skipping backup..."
            fi

            echo "ðŸ“‚ Cleaning old backups (keeping 3 latest)..."
            cd ${BACKUP_DIR}
            ls -t backend_backup_*.tar.gz | tail -n +4 | xargs -r rm || true

            echo "ðŸ”„ Deploying new backend code..."
            sudo rm -rf ${APP_DIR}
            sudo mkdir -p ${APP_DIR}
            sudo tar -xzf /tmp/backend.tar.gz -C ${APP_DIR}
            sudo rm -f /tmp/backend.tar.gz

            echo "ðŸ Setting up virtual environment..."
            cd ${APP_DIR}
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "ðŸ§© Creating .env file..."
            cat > .env << ENV
            FRONTEND_HOST="http://${HOST}"
            ENVIRONMENT="production"
            BACKEND_CORS_ORIGINS="http://${HOST}"
            SECRET_KEY="${SECRET_KEY}"
            DATABASE_URL="postgresql://${DB_USER}:${DB_PASS}@localhost/${DB_NAME}"
            AZURE_TENANT_ID="${AZURE_TENANT_ID}"
            AZURE_CLIENT_ID="${AZURE_CLIENT_ID}"
            AZURE_CLIENT_SECRET="${AZURE_CLIENT_SECRET}"
            AZURE_MAILBOX="${AZURE_MAILBOX}"
            ENV

            echo "ðŸ” Restarting FastAPI systemd service..."
            sudo systemctl daemon-reload
            sudo systemctl restart fastapi

            echo "âœ… Backend deployed successfully at $(date)!"
          EOF
